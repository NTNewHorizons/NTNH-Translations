name: Daily Language Packs Release

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write  # Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ PR

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
      - name: Merge PRs from Bufka2011
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÑÐµ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ PR Ð² Ð¾ÑÐ½Ð¾Ð²Ð½ÑƒÑŽ Ð²ÐµÑ‚ÐºÑƒ
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              base: 'main'
            });

            // Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ÑƒÐµÐ¼ PR Ð¾Ñ‚ Bufka2011 Ð¸ Ð¿Ñ‹Ñ‚Ð°ÐµÐ¼ÑÑ ÑÐ»Ð¸Ñ‚ÑŒ
            for (const pull of pulls) {
              if (pull.user.login !== 'Bufka2011') continue;
              
              try {
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pull.number,
                  merge_method: 'merge'
                });
                console.log(`âœ… Successfully merged PR #${pull.number}`);
              } catch (error) {
                console.log(`âš ï¸ Failed to merge PR #${pull.number}: ${error.message}`);
                // ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð´Ð°Ð¶Ðµ Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ ÑÐ»Ð¸ÑÐ½Ð¸Ñ
              }
            }

      - name: Checkout updated repository
        uses: actions/checkout@v4
        with:
          ref: main
          # ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´ Ð¿Ð¾ÑÐ»Ðµ ÑÐ»Ð¸ÑÐ½Ð¸Ñ PR
          fetch-depth: 0

      - name: Set release name
        id: vars
        run: echo "release_name=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Define language mappings and create ZIPs
        id: zip
        run: |
          declare -A LANG_MAP
          LANG_MAP["af_ZA"]="Afrikaans"
          LANG_MAP["ar_SA"]="Arabic"
          LANG_MAP["ca_ES"]="Catalan"
          LANG_MAP["cs_CZ"]="Czech"
          LANG_MAP["da_DK"]="Danish"
          LANG_MAP["de_DE"]="German"
          LANG_MAP["el_GR"]="Greek"
          LANG_MAP["en_US"]="English"
          LANG_MAP["es_ES"]="Spanish"
          LANG_MAP["fi_FI"]="Finnish"
          LANG_MAP["fr_FR"]="French"
          LANG_MAP["he_IL"]="Hebrew"
          LANG_MAP["hu_HU"]="Hungarian"
          LANG_MAP["it_IT"]="Italian"
          LANG_MAP["ja_JP"]="Japanese"
          LANG_MAP["kk_KZ"]="Kazakh"
          LANG_MAP["ko_KR"]="Korean"
          LANG_MAP["nl_NL"]="Dutch"
          LANG_MAP["no_NO"]="Norwegian"
          LANG_MAP["pl_PL"]="Polish"
          LANG_MAP["pt_BR"]="Portuguese_Brazil"
          LANG_MAP["pt_PT"]="Portuguese_Portugal"
          LANG_MAP["ro_RO"]="Romanian"
          LANG_MAP["ru_RU"]="Russian"
          LANG_MAP["sr_SP"]="Serbian"
          LANG_MAP["sv_SE"]="Swedish"
          LANG_MAP["tr_TR"]="Turkish"
          LANG_MAP["uk_UA"]="Ukrainian"
          LANG_MAP["vi_VN"]="Vietnamese"
          LANG_MAP["zh_CN"]="Chinese_Simplified"
          LANG_MAP["zh_TW"]="Chinese_Traditional"

          mkdir -p build_artifacts
          ZIP_LIST=""
          BASE_DIR=$(pwd)

          for lang_code in */; do
            lang_code="${lang_code%/}"
            if [[ "$lang_code" == ".github" || "$lang_code" == "crowdin.yml" ]]; then
              continue
            fi

            lang_name="${LANG_MAP[$lang_code]}"
            if [[ -z "$lang_name" ]]; then
              continue
            fi

            if [ ! -d "$lang_code/config" ]; then
              continue
            fi

            # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
            TEMP_DIR=$(mktemp -d)
            CONFIG_SRC="$lang_code/config"
            CONFIG_DEST="$TEMP_DIR/config"

            # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÑÑ‘ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ config/
            mkdir -p "$CONFIG_DEST"
            cp -r "$CONFIG_SRC"/. "$CONFIG_DEST" 2>/dev/null || true

            # ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÑÐµ .properties Ð² .lang
            find "$CONFIG_DEST" -type f -name "*.properties" | while read -r f; do
              mv "$f" "${f%.properties}.lang" 2>/dev/null || true
            done

            # Ð£Ð¿Ð°ÐºÐ¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ Ð² ZIP
            zip_path="build_artifacts/${lang_name}.zip"
            (
              cd "$TEMP_DIR"
              zip -r "$BASE_DIR/$zip_path" config/ -x "*.git*" "*.DS_Store" "__MACOSX/*"
            )

            # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
            rm -rf "$TEMP_DIR"

            ZIP_LIST+="$zip_path"$'\n'
          done

          # Ð—Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð°Ñ€Ñ…Ð¸Ð²Ð¾Ð² Ð² output
          if [ -z "$ZIP_LIST" ]; then
            echo "zip_files=" >> $GITHUB_OUTPUT
          else
            echo "zip_files<<EOF" >> $GITHUB_OUTPUT
            echo -e "$ZIP_LIST" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: NTNH-Translations-${{ steps.vars.outputs.release_name }}
          tag_name: NTNH-Translations-${{ steps.vars.outputs.release_name }}
          body: |
            ðŸ“¦ Daily language packs for Minecraft mods  
            ðŸ•’ Generated from branch `main` on ${{ steps.vars.outputs.release_name }}
          files: ${{ steps.zip.outputs.zip_files }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}